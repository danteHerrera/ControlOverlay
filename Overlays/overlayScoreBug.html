<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorebug</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
</head>
<body>

    <div class="scorebug">
        <video id="scorebug-transition" width="1000px">
            <source src="images/scorebug/transitions/Final.avi" type="video/avi">
        </video>
        <div id="scorebug-container">
            <img src="images/scorebug/Scorebug G7.png" id="scorebug" width="1000px">
            <img src="images/scorebug/Games/Scorebug No Games.png" id="games-left" width="1000px">
            <img src="images/scorebug/Games/Scorebug No Games.png" id="games-right" width="1000px">

            <div id="bCrop">
                <img src="images/scorebug/Games/Scorebug_bluecover7.png" id="bCover" width="1000px">
            </div>
            
            <div id="oCrop">
                <img src="images/scorebug/Games/Scorebug_orangecover7.png" id="oCover" width="1000px">
            </div>
            
            <div class="team-left">
                <div class="left-name">
                    <h1 id="name-left">BLUE</h1>
                </div>
                <div class="left-score">
                    <h1 id="score-left">0</h1>
                </div>
            </div>
            <div class="time">
                <h1 id="time">5:00</h1>
            </div>
            <div class="team-right">
                <div class="right-name">
                    <h1 id="name-right">ORANGE</h1>
                </div>
                <div class="right-score">
                    <h1 id="score-right">0</h1>
                </div>
            </div>
            <div class="lower-info">
                <h1 id="lower"></h1>
            </div>
        </div>
    </div>
<script type="module">

    (function() {
        let ws, sLength, lWins, rWins;
        let nameOverride = false;
        function init() {
            let nameLeft, nameRight;
            
            if (ws) {
                ws.onerror = ws.onopen = ws.onclose = null;
                ws.close();
            }

            ws = new WebSocket('ws://localhost:6969');
            ws.onopen = () => {
                console.log('Connection opened!');
            }
            ws.onmessage = ({ data }) => {
                try {

                    

                    let d = JSON.parse(data);
                    if (d.event == "scorebug-event") {
                        $("#time").text(d["time"]);
                        $("#score-left").text(d["Score Left"]);
                        $("#score-right").text(d["Score Right"]);

                        // $("#focused-player").text(d["Target"] == '' ? "N/A" : d["Target"]);
                    }
                    
                    if (d.event == "control-panel-info") {
                        nameOverride = d["nameOverride"];

                        sLength = d["seriesLength"];
                        if (sLength == 1 || sLength ==  3 || sLength == 5 || sLength == 7){
                            $("#bCover").attr("src", "images/scorebug/Games/Scorebug_bluecover" + sLength + ".png");
                            $("#oCover").attr("src", "images/scorebug/Games/Scorebug_orangecover" + sLength + ".png");
                        }

                        $("#lower").text(d["roundTitle"])

                        lWins = d["lTeamSScore"];
                        rWins = d["rTeamSScore"];
                        if (lWins != '' || rWins != ''){
                            $("#games-left").attr("src", "images/scorebug/Games/Scorebug G7 - Left " + lWins + ".png");
                            $("#games-right").attr("src", "images/scorebug/Games/Scorebug G7 - Right " + rWins + ".png");
                        }
                        if (lWins == '') {
                            $("#games-left").attr("src", "images/scorebug/Games/Scorebug No Games.png");
                        }
                        if (rWins == '') {
                            $("#games-right").attr("src", "images/scorebug/Games/Scorebug No Games.png");
                        }
                    }

                    if (d.event == "team-names") {
                        if(nameOverride) {
                            console.log(nameOverride);
                            console.log(d["Team Left"]);
                            $("#name-left").text(d["Team Left Override"]);
                            $("#name-right").text(d["Team Right Override"]);
                        } else {
                            console.log(nameOverride);
                            $("#name-left").text(d["Team Left"]);
                            $("#name-right").text(d["Team Right"]);
                        }
                    }


                } catch(e) {
                    console.log('Here is your raw data: ' + data);
                    console.log(`There was an error parsing: ${e.message}`);
                }   
            };
            ws.onclose = function() {
                ws = null;
            }
        }
        init();
    })();
    </script>
</body>
</html>