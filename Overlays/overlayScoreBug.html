<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorebug</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;700;900&display=swap" rel="stylesheet">
</head>
<body>

    <div class="scorebug">
        <video id="scorebug-transition" width="1000px">
            <source src="images/scorebug/transitions/Final.avi" type="video/avi">
        </video>
        <div id="scorebug-container">
            <img src="images/scorebug/Scorebug.png" id="scorebug" width="1000px">
            <div class="team-left">
                <div class="left-name">
                    <h1 id="name-left">teamName</h1>
                </div>
                <div class="left-score">
                    <h1 id="score-left">99</h1>
                </div>
            </div>
            <div class="time">
                <h1 id="time">5:00</h1>
            </div>
            <div class="team-right">
                <div class="right-name">
                    <h1 id="name-right">teamName</h1>
                </div>
                <div class="right-score">
                    <h1 id="score-right">99</h1>
                </div>
            </div>
        </div>
    </div>

    <script>
        const findPlayers = (playerGameObj, teamNum) => {
            let playerList = [];
            let teamNumList = [];
            let teamList = [];
            for(var item in playerGameObj) {
                if(playerGameObj.hasOwnProperty(item)) {
                    var value = playerGameObj[item];
                    playerList.push(item);
                }
            }
            for(var player in playerList) {
                let primePlayer = playerList[player];
                if (playerGameObj[primePlayer]['team'] == teamNum) {
                    teamNumList.push(playerList[player]);
                }
            }
            return teamNumList
        };
    </script>

    <script>
        const secondsToTime = (seconds, ms, showMs, gameObj) => {
            if (seconds==0) {
                return "00.0";
            } if (showMs) {
                if (ms%1==0) {ms = ms-1}
                console.log((new Date(ms * 1000).toISOString().substr(showMs ? 17 : 15, 4)));
                return (new Date(ms * 1000).toISOString().substr(showMs ? 17 : 15, 4));
            }
            return (new Date(seconds * 1000).toISOString().substr(showMs ? 17 : 15, 4));
            
        }
    </script>
    <script type="module">
    import { WsSubscribers } from './scripts/WS.js';

    $(() => {
        WsSubscribers.init(49322, true);

        WsSubscribers.subscribe("game", "match_created", () => {
            $('#score-left').text('0');
            $('#score-right').text('0');
            $('#time').text('5:00');
        });

        WsSubscribers.subscribe("game", "update_state", (d) => {
            $('.scorebug .time #time').text((d['game']['isOT'] ? '+' : '') + secondsToTime(d['game']['time_seconds'], d['game']['time_milliseconds'], d['game']['time_seconds'] < 60 && !d['game']['isOT'] && d['game']['time'] != 59, d))
            
            $('.scorebug .team-left .left-score #score-left').text(d['game']['teams'][0]['score'])
            $('.scorebug .team-right .right-score #score-right').text(d['game']['teams'][1]['score'])

            let teamOne = findPlayers(d['players'], 0);
            let teamTwo = findPlayers(d['players'], 1);
            
            if (teamOne[1] == null) {
                $('.scorebug .team-right .right-name #name-right').text(teamOne[0]);
            } else {
                $('.scorebug .team-left .left-name #name-left').text(d['game']['teams'][0]['name']);
            }
            if (teamTwo[1] == null) {
                $('.scorebug .team-right .right-name #name-right').text(teamTwo[0]);
            } else {
                $('.scorebug .team-right .right-name #name-right').text(d['game']['teams'][1]['name']);
            }
        });

        WsSubscribers.subscribe("game", "replay_start", (d) => {
            $('.scorebug').hide()
        })

        WsSubscribers.subscribe("game", "replay_end", (d) => {
            $('.scorebug').show()
        })

        WsSubscribers.subscribe("game", "match_ended", (d) => {
            $('#scorebug-transition').animate({opacity: 100}, {duration: 75, easing: "linear"});
            $('#scorebug-container').animate({opacity: 0}, {duration: 75, easing: "linear"});
            console.log("scorebug transition NOW");
            $('#scorebug-transition').get(0).play();
            setTimeout(() => {$('#scorebug-transition').animate({opacity: 0}, {duration: 1, easing: "linear"})}, 3000);
        });

        WsSubscribers.subscribe("game", "post_countdown_begin", (d) => {
            $('#scorebug-transition').animate({opacity: 0}, {duration: 75, easing: "linear"})
            $('#scorebug-container').animate({opacity: 100}, {duration: 75, easing: "linear"})
        });
    });
    
    
    
    </script>
</body>
</html>